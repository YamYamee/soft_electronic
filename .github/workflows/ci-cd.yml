name: ìì„¸ ë¶„ë¥˜ ì‹œìŠ¤í…œ CI/CD

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/posture-classifier

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸
  test:
    runs-on: [self-hosted, runner]
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python 3.13 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          sudo apt-get update
          # PostgreSQL ê°œë°œ í—¤ë” (í•„ìš”ì‹œì—ë§Œ ì„¤ì¹˜)
          # sudo apt-get install -y postgresql-server-dev-all libpq-dev build-essential

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          # PostgreSQL ì—†ì´ ê¸°ë³¸ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
          pip install -r requirements-minimal.txt

      - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
        run: |
          echo "=== Black í¬ë§·íŒ… ê²€ì‚¬ ==="
          black --check --diff .
          echo "=== Isort import ì •ë ¬ ê²€ì‚¬ ==="
          isort --check-only --diff .
          echo "=== Flake8 ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ==="
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "=== í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ==="
          # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export ENVIRONMENT=test
          export LOG_LEVEL=DEBUG
          export PYTHONPATH=$PWD:$PYTHONPATH
          
          echo "=== Python íŒ¨í‚¤ì§€ í™•ì¸ ==="
          pip list | grep -E "(fastapi|httpx|pytest)"
          
          echo "=== Python ê²½ë¡œ í™•ì¸ ==="
          python -c "import sys; print('\\n'.join(sys.path))"
          
          echo "=== ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸ ==="
          python -c "from posture_classifier import PostureClassifier; print('PostureClassifier import ì„±ê³µ')"
          python -c "from websocket_server import app; print('websocket_server import ì„±ê³µ')"
          
          echo "=== ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ==="
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --tb=short
          
          echo "=== í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ==="
          echo "Coverage report generated in htmlcov/"

      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    runs-on: [self-hosted, runner]
    needs: test
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
        run: |
          pip install safety bandit
          echo "=== ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº” ==="
          safety check
          echo "=== ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº” ==="
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true

      - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: bandit-report.json

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ
  build:
    runs-on: [self-hosted, runner]
    needs: [test, security-scan]
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    runs-on: [self-hosted, runner]
    needs: build
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" >> .env
          echo "REDIS_URL=${{ secrets.STAGING_REDIS_URL }}" >> .env
          echo "ENVIRONMENT=staging" >> .env
          echo "LOG_LEVEL=DEBUG" >> .env

      - name: Docker Composeë¡œ ìŠ¤í…Œì´ì§• ë°°í¬
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.staging.yml down || true
          docker-compose -f docker-compose.yml -f docker-compose.staging.yml pull
          docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          echo "=== ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ==="
          docker-compose ps
          echo "=== í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ==="
          sleep 30
          curl -f http://localhost:8000/health || exit 1
          echo "âœ… ìŠ¤í…Œì´ì§• ë°°í¬ ì™„ë£Œ"

      - name: Slack ì•Œë¦¼
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployment"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

  # í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    runs-on: [self-hosted, runner]
    needs: [build, deploy-staging]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í”„ë¡œë•ì…˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DATABASE_URL=${{ secrets.PROD_DATABASE_URL }}" >> .env
          echo "REDIS_URL=${{ secrets.PROD_REDIS_URL }}" >> .env
          echo "ENVIRONMENT=production" >> .env
          echo "LOG_LEVEL=INFO" >> .env

      - name: ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
        run: |
          echo "=== í”„ë¡œë•ì…˜ DB ë°±ì—… ==="
          docker exec posture_db pg_dump -U posture_user posture_classification > backup_$(date +%Y%m%d_%H%M%S).sql

      - name: Blue-Green ë°°í¬
        run: |
          echo "=== Blue-Green ë°°í¬ ì‹œì‘ ==="

          # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹œì‘ (Green)
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale posture_server=2

          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          sleep 60

          # ìƒˆ ì¸ìŠ¤í„´ìŠ¤ í—¬ìŠ¤ì²´í¬
          NEW_CONTAINER=$(docker ps --filter "name=posture_websocket_server" --format "{{.Names}}" | head -1)
          NEW_PORT=$(docker port $NEW_CONTAINER 8000 | cut -d: -f2)

          if curl -f http://localhost:$NEW_PORT/health; then
            echo "âœ… ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ì •ìƒ ë™ì‘"
            
            # ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±° (Blue)
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale posture_server=1
            
            echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ"
          else
            echo "âŒ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale posture_server=1
            exit 1
          fi

      - name: ë°°í¬ í›„ ê²€ì¦
        run: |
          echo "=== ë°°í¬ í›„ ê²€ì¦ ==="
          curl -f http://localhost:8000/health
          curl -f http://localhost:8000/ | grep "ìì„¸ ë¶„ë¥˜"

          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
          docker exec posture_db psql -U posture_user -d posture_classification -c "SELECT 1;"

          # Redis ì—°ê²° í™•ì¸
          docker exec posture_redis redis-cli ping

          echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼"

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: "#deployment"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            ğŸš€ ìì„¸ ë¶„ë¥˜ ì‹œìŠ¤í…œ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!
            ğŸ“‹ ì»¤ë°‹: ${{ github.sha }}
            ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}
            ğŸŒ URL: https://your-domain.com

  # ë¡¤ë°± ì‘ì—…
  rollback:
    runs-on: [self-hosted, runner]
    if: failure() && github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
        run: |
          echo "=== ë¡¤ë°± ì‹œì‘ ==="

          # ì´ì „ ì´ë¯¸ì§€ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1)

          # ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
          docker-compose down
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$PREVIOUS_TAG
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$PREVIOUS_TAG ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker-compose up -d

          echo "âœ… ë¡¤ë°± ì™„ë£Œ: $PREVIOUS_TAG"

      - name: ë¡¤ë°± ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          channel: "#deployment"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            âš ï¸ ìì„¸ ë¶„ë¥˜ ì‹œìŠ¤í…œ ë¡¤ë°± ì‹¤í–‰ë¨
            ğŸ“‹ ë¡¤ë°±ëœ ì»¤ë°‹: ${{ github.sha }}
            ğŸ”„ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ ì™„ë£Œ
