name: Fast CI/CD

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, runner]
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹ ë¥¸ ë°°í¬
        run: |
          echo "ğŸš€ ì´ˆê³ ì† ë°°í¬ ì‹œì‘ (Docker ê±´ë„ˆë›°ê¸°)"

          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "ë””ìŠ¤í¬ ê³µê°„ í™•ì¸..."

      - name: ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
        run: cd ${{ github.workspace }}/soft_electronic
          df -h

          # Docker ë° ì‹œìŠ¤í…œ ê³µê°„ ì •ë¦¬
          echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ, ì´ë¯¸ì§€, ë³¼ë¥¨, ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ ì¤‘..."
          docker container prune -f || true
          docker image prune -af || true
          docker volume prune -f || true
          docker network prune -f || true
          echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒ¨í‚¤ì§€ ë° ìºì‹œ ì •ë¦¬ ì¤‘..."
          sudo apt-get clean || true
          sudo apt-get autoremove -y || true
          rm -rf ~/.cache/pip || true
          echo "ê³µê°„ ì •ë¦¬ ì™„ë£Œ"

          # Docker ê±´ë„ˆë›°ê³  Python ì§ì ‘ ì‹¤í–‰
          echo "Python ì§ì ‘ ì‹¤í–‰ ëª¨ë“œ"

          # Python í™˜ê²½ ì„¤ì •
          # pipì´ ì—†ì„ ê²½ìš° ì„¤ì¹˜
          python3 -m ensurepip --upgrade || sudo apt-get install python3-pip -y
          python3 -m pip install --upgrade pip --user --break-system-packages
          pip3 install -r requirements-minimal.txt --user --break-system-packages

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          pkill -f "python.*websocket_server.py" || true
          pkill -f "websocket_server" || true

          # í¬íŠ¸ 8000 ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          sudo lsof -ti:8000 | xargs -r sudo kill -9 || true

          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ìë™ ì‹¤í–‰ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¬ì‹œì‘)
          pkill -f "python.*websocket_server.py" || true
          nohup python3 ./websocket_server.py > server.log 2>&1 &

          echo "ì„œë²„ ì‹œì‘ ì¤‘..."
          sleep 10

          # í—¬ìŠ¤ì²´í¬
          cd ${{ github.workspace }}/soft_electronic
          nohup python3 ./websocket_server.py > server.log 2>&1 &

          echo "âœ… ë°°í¬ ì™„ë£Œ! http://localhost:8000"
          echo "ğŸ¯ ë¡œê·¸ í™•ì¸: tail -f server.log"
